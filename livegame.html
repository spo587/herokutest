<script src="/node_modules/socket.io/node_modules/socket.io-client/socket.io.js"></script>
<script src="/utilities/jquery.js"></script>
<script src='./helperFunctions.js'></script>
<script src='./domFunctions.js'></script>
<script src='./noGlobalFunctions.js'></script>
<script src="./setgameNoClicks.js"></script>
<script>
var gameType = document.URL.split('/')[document.URL.split('/').length - 1];
console.log(gameType);
var SETLENGTH = gameType.slice(0,gameType.length - 1) === 'superSet' ? 4 : 3;
console.log(SETLENGTH);
</script>

<body>
    <h1 id='intro'> Set! </h1>
    <a href='/'> Return to home page </a><br>
    
    <button type='button' id='start-game' class='button'> click me to start a new game </button>
    <br><button type='button' id='shuffle' onclick='shuffleBoardCards()'>click to shuffle the board</button>
    <button type='button' id='click-reset' onclick='clickReset()'>Click here if the clicking isn't working for some reason (working on it)</button>
    <br> number of people in game: <span id='numclients'> 1 </span>
    
    <div id='players'></div>
    
    <p id='time-paragraph'>Time elapsed: <span id='time'></span></p>

    
    <div id='div1'></div>
    <ul id="messages"></ul>
    <form action="">
      <input id="m" autocomplete="off" /><button>Trash talk</button>
    </form>
    <div id='hint'><button type='button' onclick='hintCard()'>Give up? Click for hint</button>
        <p id='hint-card-position'></p></div>
    <div id='sets'><p></p></div>
    
    <script>
    $('#intro').text(gameType.slice(0, gameType.length - 1) + '!!!');
    function clickReset(){
        var cards = cardnumarray_numbers();
        clickListenersOff();
        addEventListeners(cards, SETLENGTH);
    }
    //get name
    //var playerName;
    var grandSetsObj = {};
    // $(document).ready(function(){
    //     playerName = prompt("Your name please", '');
    //     //socket.emit('name entered');
    // });
    function adjustSets(setsPerPlayerObj){
        forEachIn(setsPerPlayerObj, function(prop, val){
            //console.log(prop);
            //console.log(val);
            $('#' + prop).text(prop + '\'s set count: ' + String(val));

        });
    }
    var nickname;
    // var setType;
    // var SETLENGTH;
    var depletedBoard;
    function setUpPregame(socket){
        //var numPlayers = 1;
        socket.on('connect', function(data){
            nickname = prompt("Your name, please", 'anonymous' + String(Math.round(1000*Math.random())));
            //socket.nickname = nickname;
            socket.emit('join', nickname);

        });
        socket.on('adjustSets', function(setsPerPlayerObj){
            adjustSets(setsPerPlayerObj);
        })
        socket.on('allPlayers', function(setsPerPlayerObj){

            //console.log(setsPerPlayerObj);

            $('#players').text('');
            $('#sets').text('');
            forEachIn(setsPerPlayerObj, function(prop, val){
                var newp = dom('P', {id: prop}, prop + '\'s set count: ' + String(val));
                $('#players').append(newp);
                var dummy = dom('P', null, prop + '\'s sets: ');
                var setp = dom('P', {id: prop + '-sets'});
                $('#sets').append(dummy).append(setp);

            });
            var numPlayers = Object.size(setsPerPlayerObj);
            $('#numclients').text(String(numPlayers));
            
            //console.log(players);
        });

        
        socket.on('disconnect', function(numPlayers){
            var current = $('#numclients').text();
            $('#numclients').text(String(numPlayers));
        });
        socket.on('player has departed', function(name){
            alert(name + ' left :(');
            
        });
        socket.on('game over', function(data){
            var t = data.t;
            var setsPerPlayerObj = data.setsPerPlayer;
            var max = 0;
            var winner;
            forEachIn(setsPerPlayerObj, function(prop, val){
                if (val > max){
                    winner = prop;
                    max = val;
                }
            });
            alert('game over! ' + winner + ' won! ' + 'game time : ' + String(t) + ' seconds ');
        });



    }

    function startGame(socket){
        $('#start-game').click(function(){
            if ($('IMG').length > 0){

            }
            // setType = $('input[name=gameType]:checked').val();
            // SETLENGTH = setType === 'superSet' ? 4 : 3;
            
            //console.log('click');
            console.log(SETLENGTH);
            socket.emit('start game', SETLENGTH); //$('#paragraph').html());
            //$('#paragraph').html('');

            return false;
        });
    }

    function chatForm(socket){

        $('form').submit(function(){
            var data = {playerName: nickname, msg: $('#m').val()}
            socket.emit('chat message', data);
            $('#m').val('');
            return false;
          });

        socket.on('chat message', function(data){
            //console.log('incoming message');
            $('#messages').append($('<li>').text(data.playerName + ':  ' + data.msg));
        });
    }

    function checkThreeClicks(clickedOpp){
        var clickedCardNums = clickedOpp.map(function(current){
            return convertCardBack(current);
        });
        // var clickedCardDoms = clickedCardNums.map(function(current){
        //     return $('#' + String(current))[0];
        // });
        clickedCardNums.forEach(function(current){
            changeBorderStyle(current)
        });

    }
    var oppFindSet;

    function cardClicks(socket){
        // socket.on('cardClick', function(data){
        //     var id = data.card;
        //     var clickedOpp = data.clicked;
        //     console.log(id);
            
        //     //var card = $('#' + String(id))[0];
        //     //var currentColor = card.style.borderColor;
        //     changeBorderStyle(id);
            
        //     if (clickedOpp.length === 3) {
        //         checkThreeClicks(clickedOpp);
        //     }
        // });

        socket.on('noClicksUntil', function(data){
            var card = data.card;
            changeBorderStyle(card);
            clickListenersOff();
            oppFindSet = setTimeout(function(){
                var cards = cardnumarray_numbers();
                clickListenersOff();
                allBordersSolid();
                addEventListeners(cards, SETLENGTH);
                socket.emit('clickBanExpiring');

            }, 600 * SETLENGTH);
        });
        socket.on('secondCardClick', function(card){
            changeBorderStyle(card);
        });
    }

    var deck;
    

    function dealFunctions(socket){
        //var deck;
        socket.on('order of deck', function(data){
            console.log(SETLENGTH);
            deck = data.deck;

            SETLENGTH = data.SETLENGTH;
            console.log(SETLENGTH);
            var type = SETLENGTH === 4 ? 'superSet' : 'set';
            $('#' + type).prop('checked', true);
            $('#intro').text(type + '!')
            depletedBoard = SETLENGTH === 4 ? 5 : 9;
            var firstCards = deck.splice(0, 36 / SETLENGTH);
            //console.log(firstTwelve);
            firstDeal(firstCards, SETLENGTH);
            timer();
            
            //return orderedDeck;
        });

        socket.on('dealing next three', function(){
            console.log('dealing next three');
            var cardsOnBoard = cardnumarray_numbers();
            if (cardsOnBoard.length <= depletedBoard){
                var cards = deck.splice(0, SETLENGTH);
                dealThree(cards);
                //checkDeadboardAndDeal();
            }
            //addEventListeners(cardsOnBoard);
            // else {
            //     console.log('checking for deadboard');
            //     //checkDeadboardAndDeal();
            // }
        });

        socket.on('force deal next three', function(){
            var cards = deck.splice(0, 3);
            dealThree(cards);
        });
        socket.on('set found', function(data){
            var cards = data.cards;
            var setsPerPlayerObj = data.setsPerPlayer;
            console.log(cards);
            clearTimeout(oppFindSet);
            socket.emit('clickBanExpiring');
            //console.log('firing event');
            //setsOpponents[player] += 1
            console.log(setsPerPlayerObj);
            adjustSets(setsPerPlayerObj);
            
            //$('#' + player).text(player + '\'s sets: ' + String(setsOpponent));
            //console.log(cards);
            // var cardNumbers = cards.map(function(current){
            //     return convertCardBack(current);
            // });
            //console.log(cardNumbers);
            removeDeal(cards);
            console.log('okay');
            addToSetsOnScreen(cards, data.player);
        });
        socket.on('falsey', function(){
            var current = $('#setsFoundOpponent').text();
            $('#setsFoundOpponent').text(String(Number(current) - 1));
        });
        socket.on('show hintcard', function(){
            displayHint();
        });

    }

    function fullSetUp(socket){
        setUpPregame(socket);
        startGame(socket);
        chatForm(socket);
        cardClicks(socket);
        dealFunctions(socket);   
    }
    var socket = io('/' + document.URL.split('/')[document.URL.split('/').length - 1]);
    //var socket = io('/livegame' + document.URL[document.URL.length - 1]);
    fullSetUp(socket);
    </script>
</body>