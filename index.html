<script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
<script src='https://dl.dropboxusercontent.com/u/95890750/set/set.js'></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>

<body>
    <h1> Set! </h1>
    <p>Click on a link below to join a game</p>
    <p><a href='/oneplayer'>click here to play timed one player game</a></p>
    <p><a href='/besttime'> click to see best time</a></p>
    <div id='start-game'>
        <a id='start-game-link' href='/livegame0'>click to start a new game (no games currently waiting)</a><br>
    </div>
    <div id='games-in-progress'></div>
    
    <script>
    var socket = io('/');
    
    socket.on('player joined game', function(visitCounter){
        var gameCounter = 0;
        forEachIn(visitCounter, function(prop, val){
            gameCounter += visitCounter[prop] > 0 ? 1 : 0;
        });
        setLinksToWaitingGames(visitCounter);
        if (gameCounter > 0){
            changeLinkForNewGame(visitCounter);
        }
        
        //resetGameLinks(visitCounter);
        socket.on('player left game', function(visitCounter){
            setLinksToWaitingGames(visitCounter);
            changeLinkForNewGame(visitCounter);
        });       
    });
    function setLinksToWaitingGames(visitCounter){
        $('#games-in-progress').html('');
        forEachIn(visitCounter, function(prop, val){
            if (val === 1){
                var id = Number(prop[prop.length - 1]);
                var newLink = dom('A', {id: id, href: '/' + prop}, 'click to join game ' + String(id) + ' , player waiting!');
                $('#games-in-progress').append(newLink).append('<br>');
            }
        });
    }
    function findLowestOpenGameNumber(visitCounter){
        //some bug in this function, doesn't go to the min call somehow
        var lowestOpenGame;
        console.log(lowestOpenGame);
        forEachIn(visitCounter, function(prop, val){
            if (visitCounter[prop] === 0){
                if (!lowestOpenGame){
                    console.log('assigning lowestopengame not with min to next one');
                    lowestOpenGame = Number(prop[prop.length - 1]);
                }
                else {
                    console.log('assigning with min');
                    lowestOpenGame = Math.min(Number(prop[prop.length - 1]), lowestOpenGame);
                }
                console.log(lowestOpenGame);
            }
        });
        return lowestOpenGame;
    }

    function changeLinkForNewGame(visitCounter){
        //fix this!!!
        $('#start-game').html('');
        //debugger;
        var id = findLowestOpenGameNumber(visitCounter);
        var newLink = dom('A', {id: id, href: '/livegame' + String(id)}, 'click to start new game');
        $('#start-game').append(newLink).append('<br>');
        
    }

    function forEachIn(object, func) {
        for (var property in object) {
            if (object.hasOwnProperty(property))
                func(property, object[property])
        }
    }
    
    </script>

</body>